const Contact = require('../../model/Contact');
const { sendMail } = require('../../utils/sendMail');

// [GET] /admin/contacts - Danh s√°ch li√™n h·ªá
module.exports.index = async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = 10;
    const search = req.query.search || '';
    const status = req.query.status || '';
    
    const filters = { search, status };
    
    // L·∫•y d·ªØ li·ªáu v·ªõi ph√¢n trang
    const contacts = await Contact.getPaginated(page, limit, filters);
    const total = await Contact.getCount(filters);
    const totalPages = Math.ceil(total / limit);
    
    // L·∫•y th·ªëng k√™
    const stats = await Contact.getStats();
    
    // Chuy·ªÉn ƒë·ªïi stats th√†nh object d·ªÖ s·ª≠ d·ª•ng
    const statsObj = {
      new: 0,
      read: 0,
      replied: 0,
      total: total
    };
    
    stats.forEach(stat => {
      statsObj[stat._id] = stat.count;
    });
    
    // Check if request wants JSON (API)
    if (req.headers.accept && req.headers.accept.includes('application/json')) {
      return res.json({
        success: true,
        data: {
          contacts,
          pagination: {
            currentPage: page,
            totalPages,
            total,
            limit
          },
          filters: { search, status },
          stats: statsObj
        }
      });
    }
    
    res.render('admin/layout', {
      pageTitle: 'Qu·∫£n l√Ω Li√™n h·ªá',
      page: 'contacts',
      user: req.user,
      contacts,
      currentPage: page,
      totalPages,
      total,
      search,
      status,
      stats: statsObj,
      req: req,
      body: 'admin/pages/contacts/index'
    });
    
  } catch (error) {
    console.error('Contacts index error:', error);
    
    if (req.headers.accept && req.headers.accept.includes('application/json')) {
      return res.status(500).json({
        success: false,
        message: 'L·ªói server',
        error: error.message
      });
    }
    
    req.flash('error', 'C√≥ l·ªói x·∫£y ra khi t·∫£i danh s√°ch li√™n h·ªá');
    res.render('admin/layout', {
      pageTitle: 'Qu·∫£n l√Ω Li√™n h·ªá',
      page: 'contacts',
      user: req.user,
      contacts: [],
      currentPage: 1,
      totalPages: 0,
      total: 0,
      search: '',
      status: '',
      stats: { new: 0, read: 0, replied: 0, total: 0 },
      req: req,
      body: 'admin/pages/contacts/index'
    });
  }
};

// [GET] /admin/contacts/:id - Chi ti·∫øt li√™n h·ªá
module.exports.show = async (req, res) => {
  try {
    // Validate ObjectId format
    if (!req.params.id || !/^[0-9a-fA-F]{24}$/.test(req.params.id)) {
      console.log('‚ùå [CONTACT SHOW] Invalid ObjectId format:', { id: req.params.id });
      if (req.headers.accept && req.headers.accept.includes('application/json')) {
        return res.status(400).json({
          success: false,
          message: 'ID li√™n h·ªá kh√¥ng h·ª£p l·ªá'
        });
      }
      req.flash('error', 'ID li√™n h·ªá kh√¥ng h·ª£p l·ªá');
      return res.redirect('/admin/contacts');
    }
    
    const contact = await Contact.findById(req.params.id);
    
    if (!contact) {
      if (req.headers.accept && req.headers.accept.includes('application/json')) {
        return res.status(404).json({
          success: false,
          message: 'Kh√¥ng t√¨m th·∫•y li√™n h·ªá'
        });
      }
      req.flash('error', 'Kh√¥ng t√¨m th·∫•y li√™n h·ªá');
      return res.redirect('/admin/contacts');
    }
    
    // ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc n·∫øu ch∆∞a ƒë·ªçc
    if (contact.status === 'new') {
      await contact.markAsRead();
    }
    
    // Check if request wants JSON (API)
    if (req.headers.accept && req.headers.accept.includes('application/json')) {
      return res.json({
        success: true,
        data: contact
      });
    }
    
    res.render('admin/layout', {
      pageTitle: `Chi ti·∫øt li√™n h·ªá: ${contact.name}`,
      page: 'contacts',
      user: req.user,
      contact,
      req: req,
      body: 'admin/pages/contacts/show'
    });
    
  } catch (error) {
    console.error('Show contact error:', error);
    
    if (req.headers.accept && req.headers.accept.includes('application/json')) {
      return res.status(500).json({
        success: false,
        message: 'L·ªói server',
        error: error.message
      });
    }
    
    req.flash('error', 'C√≥ l·ªói x·∫£y ra');
    res.redirect('/admin/contacts');
  }
};

// [DELETE] /admin/contacts/:id - X√≥a li√™n h·ªá
module.exports.delete = async (req, res) => {
  try {
    // Validate ObjectId format
    if (!req.params.id || !/^[0-9a-fA-F]{24}$/.test(req.params.id)) {
      console.log('‚ùå [CONTACT DELETE] Invalid ObjectId format:', { id: req.params.id });
      if (req.headers.accept && req.headers.accept.includes('application/json')) {
        return res.status(400).json({
          success: false,
          message: 'ID li√™n h·ªá kh√¥ng h·ª£p l·ªá'
        });
      }
      req.flash('error', 'ID li√™n h·ªá kh√¥ng h·ª£p l·ªá');
      return res.redirect('/admin/contacts');
    }
    
    const contact = await Contact.findById(req.params.id);
    
    if (!contact) {
      if (req.headers.accept && req.headers.accept.includes('application/json')) {
        return res.status(404).json({
          success: false,
          message: 'Kh√¥ng t√¨m th·∫•y li√™n h·ªá'
        });
      }
      req.flash('error', 'Kh√¥ng t√¨m th·∫•y li√™n h·ªá');
      return res.redirect('/admin/contacts');
    }
    
    await Contact.findByIdAndDelete(req.params.id);
    
    if (req.headers.accept && req.headers.accept.includes('application/json')) {
      return res.json({
        success: true,
        message: 'X√≥a li√™n h·ªá th√†nh c√¥ng'
      });
    }
    
    req.flash('success', 'X√≥a li√™n h·ªá th√†nh c√¥ng');
    res.redirect('/admin/contacts');
    
  } catch (error) {
    console.error('Delete contact error:', error);
    
    if (req.headers.accept && req.headers.accept.includes('application/json')) {
      return res.status(500).json({
        success: false,
        message: 'L·ªói server',
        error: error.message
      });
    }
    
    req.flash('error', 'C√≥ l·ªói x·∫£y ra khi x√≥a li√™n h·ªá');
    res.redirect('/admin/contacts');
  }
};

// [PATCH] /admin/contacts/:id/mark-read - ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
module.exports.markAsRead = async (req, res) => {
  try {
    // Validate ObjectId format
    if (!req.params.id || !/^[0-9a-fA-F]{24}$/.test(req.params.id)) {
      console.log('‚ùå [CONTACT MARK READ] Invalid ObjectId format:', { id: req.params.id });
      if (req.headers.accept && req.headers.accept.includes('application/json')) {
        return res.status(400).json({
          success: false,
          message: 'ID li√™n h·ªá kh√¥ng h·ª£p l·ªá'
        });
      }
      req.flash('error', 'ID li√™n h·ªá kh√¥ng h·ª£p l·ªá');
      return res.redirect('/admin/contacts');
    }
    
    const contact = await Contact.findById(req.params.id);
    
    if (!contact) {
      if (req.headers.accept && req.headers.accept.includes('application/json')) {
        return res.status(404).json({
          success: false,
          message: 'Kh√¥ng t√¨m th·∫•y li√™n h·ªá'
        });
      }
      req.flash('error', 'Kh√¥ng t√¨m th·∫•y li√™n h·ªá');
      return res.redirect('/admin/contacts');
    }
    
    await contact.markAsRead();
    
    // Always return JSON for AJAX requests
    return res.json({
      success: true,
      message: 'ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc th√†nh c√¥ng'
    });
    
  } catch (error) {
    console.error('Mark as read error:', error);
    
    return res.status(500).json({
      success: false,
      message: 'L·ªói server',
      error: error.message
    });
  }
};

// [PATCH] /admin/contacts/:id/mark-replied - ƒê√°nh d·∫•u ƒë√£ tr·∫£ l·ªùi
module.exports.markAsReplied = async (req, res) => {
  try {
    // Validate ObjectId format
    if (!req.params.id || !/^[0-9a-fA-F]{24}$/.test(req.params.id)) {
      console.log('‚ùå [CONTACT MARK REPLIED] Invalid ObjectId format:', { id: req.params.id });
      if (req.headers.accept && req.headers.accept.includes('application/json')) {
        return res.status(400).json({
          success: false,
          message: 'ID li√™n h·ªá kh√¥ng h·ª£p l·ªá'
        });
      }
      req.flash('error', 'ID li√™n h·ªá kh√¥ng h·ª£p l·ªá');
      return res.redirect('/admin/contacts');
    }
    
    const contact = await Contact.findById(req.params.id);
    
    if (!contact) {
      if (req.headers.accept && req.headers.accept.includes('application/json')) {
        return res.status(404).json({
          success: false,
          message: 'Kh√¥ng t√¨m th·∫•y li√™n h·ªá'
        });
      }
      req.flash('error', 'Kh√¥ng t√¨m th·∫•y li√™n h·ªá');
      return res.redirect('/admin/contacts');
    }
    
    await contact.markAsReplied();
    
    // Always return JSON for AJAX requests
    return res.json({
      success: true,
      message: 'ƒê√°nh d·∫•u ƒë√£ tr·∫£ l·ªùi th√†nh c√¥ng'
    });
    
  } catch (error) {
    console.error('Mark as replied error:', error);
    
    return res.status(500).json({
      success: false,
      message: 'L·ªói server',
      error: error.message
    });
  }
};

// [POST] /admin/contacts/reply/:id - G·ª≠i email tr·∫£ l·ªùi
module.exports.reply = async (req, res) => {
  try {
    console.log('üìß [EMAIL REPLY] Request received:', {
      timestamp: new Date().toISOString(),
      method: req.method,
      url: req.url,
      params: req.params,
      body: req.body,
      userAgent: req.get('User-Agent'),
      ip: req.ip
    });
    
    const { subject, message } = req.body;
    const contactId = req.params.id;
    
    // Validate ObjectId format
    if (!contactId || !/^[0-9a-fA-F]{24}$/.test(contactId)) {
      console.log('‚ùå [EMAIL REPLY] Invalid ObjectId format:', { contactId });
      if (req.headers.accept && req.headers.accept.includes('application/json')) {
        return res.status(400).json({
          success: false,
          message: 'ID li√™n h·ªá kh√¥ng h·ª£p l·ªá'
        });
      }
      req.flash('error', 'ID li√™n h·ªá kh√¥ng h·ª£p l·ªá');
      return res.redirect('/admin/contacts');
    }
    
    console.log('üìß [EMAIL REPLY] Processing request:', {
      contactId,
      subject: subject ? subject.substring(0, 50) + '...' : 'null',
      messageLength: message ? message.length : 0,
      hasSubject: !!subject,
      hasMessage: !!message
    });
    
    // Validation
    if (!subject || !message) {
      console.log('‚ùå [EMAIL REPLY] Validation failed:', {
        hasSubject: !!subject,
        hasMessage: !!message,
        subjectValue: subject,
        messageValue: message
      });
      
      if (req.headers.accept && req.headers.accept.includes('application/json')) {
        return res.status(400).json({
          success: false,
          message: 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung'
        });
      }
      req.flash('error', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung');
      return res.redirect(`/admin/contacts/${contactId}`);
    }
    
    // T√¨m contact
    console.log('üìß [EMAIL REPLY] Looking for contact:', { contactId });
    const contact = await Contact.findById(contactId);
    if (!contact) {
      console.log('‚ùå [EMAIL REPLY] Contact not found:', { contactId });
      if (req.headers.accept && req.headers.accept.includes('application/json')) {
        return res.status(404).json({
          success: false,
          message: 'Kh√¥ng t√¨m th·∫•y li√™n h·ªá'
        });
      }
      req.flash('error', 'Kh√¥ng t√¨m th·∫•y li√™n h·ªá');
      return res.redirect('/admin/contacts');
    }
    
    console.log('‚úÖ [EMAIL REPLY] Contact found:', {
      contactId: contact._id,
      name: contact.name,
      email: contact.email,
      status: contact.status,
      createdAt: contact.createdAt
    });
    
    // T·∫°o n·ªôi dung email HTML
    const emailHtml = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #2c3e50; margin: 0 0 10px 0;">H√† N·ªôi Vibes</h2>
          <p style="color: #6c757d; margin: 0;">C·∫£m ∆°n b·∫°n ƒë√£ li√™n h·ªá v·ªõi ch√∫ng t√¥i!</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
          <h3 style="color: #2c3e50; margin: 0 0 15px 0;">${subject}</h3>
          <div style="color: #495057; line-height: 1.6; white-space: pre-wrap;">${message}</div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 6px; font-size: 14px; color: #6c757d;">
          <p style="margin: 0 0 10px 0;"><strong>Th√¥ng tin li√™n h·ªá g·ªëc:</strong></p>
          <p style="margin: 0 0 5px 0;"><strong>T√™n:</strong> ${contact.name}</p>
          <p style="margin: 0 0 5px 0;"><strong>Email:</strong> ${contact.email}</p>
          <p style="margin: 0 0 5px 0;"><strong>Qu·ªëc gia:</strong> ${contact.country}</p>
          <p style="margin: 0;"><strong>Ng√†y g·ª≠i:</strong> ${new Date(contact.createdAt).toLocaleString('vi-VN')}</p>
        </div>
        
        <div style="margin-top: 20px; text-align: center; color: #6c757d; font-size: 12px;">
          <p>Email n√†y ƒë∆∞·ª£c g·ª≠i t·ª´ h·ªá th·ªëng qu·∫£n l√Ω li√™n h·ªá c·ªßa H√† N·ªôi Vibes</p>
          <p>Vui l√≤ng kh√¥ng tr·∫£ l·ªùi tr·ª±c ti·∫øp email n√†y.</p>
        </div>
      </div>
    `;
    
    // G·ª≠i email v·ªõi error handling
    try {
      console.log('üìß [EMAIL REPLY] Attempting to send email:', {
        to: contact.email,
        subject: `Re: ${subject}`,
        emailLength: emailHtml.length,
        timestamp: new Date().toISOString()
      });
      
      sendMail(contact.email, `Re: ${subject}`, emailHtml);
      
      console.log('‚úÖ [EMAIL REPLY] Email sent successfully:', {
        to: contact.email,
        subject: `Re: ${subject}`,
        timestamp: new Date().toISOString()
      });
    } catch (emailError) {
      console.error('‚ùå [EMAIL REPLY] Failed to send email:', {
        error: emailError.message,
        stack: emailError.stack,
        to: contact.email,
        subject: `Re: ${subject}`,
        timestamp: new Date().toISOString()
      });
      throw new Error(`Kh√¥ng th·ªÉ g·ª≠i email: ${emailError.message}`);
    }
    
    // ƒê√°nh d·∫•u ƒë√£ tr·∫£ l·ªùi
    console.log('üìß [EMAIL REPLY] Marking contact as replied:', { contactId });
    await contact.markAsReplied();
    console.log('‚úÖ [EMAIL REPLY] Contact marked as replied successfully');
    
    console.log('‚úÖ [EMAIL REPLY] Reply process completed successfully:', {
      contactId,
      to: contact.email,
      subject: `Re: ${subject}`,
      timestamp: new Date().toISOString()
    });
    
    if (req.headers.accept && req.headers.accept.includes('application/json')) {
      return res.json({
        success: true,
        message: 'Email tr·∫£ l·ªùi ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng'
      });
    }
    
    req.flash('success', 'Email tr·∫£ l·ªùi ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng');
    res.redirect(`/admin/contacts/${contactId}`);
    
  } catch (error) {
    console.error('‚ùå [EMAIL REPLY] Error occurred:', {
      error: error.message,
      stack: error.stack,
      contactId: req.params.id,
      timestamp: new Date().toISOString(),
      requestBody: req.body
    });
    
    if (req.headers.accept && req.headers.accept.includes('application/json')) {
      return res.status(500).json({
        success: false,
        message: 'L·ªói server khi g·ª≠i email',
        error: error.message
      });
    }
    
    req.flash('error', 'C√≥ l·ªói x·∫£y ra khi g·ª≠i email tr·∫£ l·ªùi');
    res.redirect(`/admin/contacts/${req.params.id}`);
  }
};

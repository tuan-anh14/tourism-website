<!-- Header -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2"><%= pageTitle %></h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <a href="/admin/transportations" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>Quay lại</a>
  </div>
  </div>

<!-- Flash -->
<% if (typeof flash !== 'undefined' && flash.error && flash.error.length > 0) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= flash.error[0] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>
<% if (typeof flash !== 'undefined' && flash.success && flash.success.length > 0) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= flash.success[0] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<form method="POST" action="/admin/transportations/edit/<%= item._id %>?_method=PATCH" enctype="multipart/form-data">
  <div class="row">
    <!-- Basic info -->
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông tin cơ bản</h5></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Tên</label>
              <input type="text" class="form-control" name="name" value="<%= item.name || '' %>">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Tên EN</label>
              <input type="text" class="form-control" name="nameEn" value="<%= item.nameEn || '' %>">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Danh mục</label>
              <select class="form-select" name="category">
                <% (categories||[]).forEach(c => { %>
                  <option value="<%= c.value %>" <%= item.category===c.value?'selected':'' %>><%= c.label %></option>
                <% }) %>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Loại</label>
              <select class="form-select" name="type">
                <% (types||[]).forEach(t => { %>
                  <option value="<%= t.value %>" <%= item.type===t.value?'selected':'' %>><%= t.label %></option>
                <% }) %>
              </select>
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">Mô tả</label>
              <textarea class="form-control" name="description" rows="4"><%= item.description || '' %></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Features & Tips -->
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0"><i class="fas fa-tags me-2"></i>Đặc điểm & Tips</h5></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Đặc điểm</label>
              <div id="features-container">
                <% (item.features||['']).forEach(val => { %>
                <div class="input-group mb-2">
                  <input type="text" class="form-control" name="features[]" value="<%= val %>" placeholder="VD: Nhanh, tiện lợi">
                  <button type="button" class="btn btn-outline-danger" onclick="removeField(this)"><i class="fas fa-times"></i></button>
                </div>
                <% }) %>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="addField('features-container','features[]','VD: Nhanh, tiện lợi')"><i class="fas fa-plus me-1"></i>Thêm</button>
            </div>
            <div class="col-md-6">
              <label class="form-label">Tips</label>
              <div id="tips-container">
                <% (item.tips||['']).forEach(val => { %>
                <div class="input-group mb-2">
                  <input type="text" class="form-control" name="tips[]" value="<%= val %>" placeholder="VD: Tránh giờ cao điểm">
                  <button type="button" class="btn btn-outline-danger" onclick="removeField(this)"><i class="fas fa-times"></i></button>
                </div>
                <% }) %>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="addField('tips-container','tips[]','VD: Tránh giờ cao điểm')"><i class="fas fa-plus me-1"></i>Thêm</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pricing & Hours -->
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0"><i class="fas fa-money-bill me-2"></i>Giá & Thời gian hoạt động</h5></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Giá từ</label>
              <input type="number" class="form-control" name="priceRange[from]" step="any" value="<%= (item.priceRange && item.priceRange.from) || '' %>">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Giá đến</label>
              <input type="number" class="form-control" name="priceRange[to]" step="any" value="<%= (item.priceRange && item.priceRange.to) || '' %>">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Đơn vị</label>
              <input type="text" class="form-control" name="priceRange[currency]" value="<%= (item.priceRange && item.priceRange.currency) || 'VND' %>">
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">Ghi chú giá</label>
              <input type="text" class="form-control" name="priceRange[note]" value="<%= (item.priceRange && item.priceRange.note) || '' %>">
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">Giờ hoạt động</label>
              <input type="text" class="form-control" name="operatingHours" value="<%= item.operatingHours || '' %>">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Routes -->
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0"><i class="fas fa-route me-2"></i>Tuyến/Thông tin</h5></div>
        <div class="card-body">
          <div id="routes">
            <% (item.routes||[]).forEach((r, idx)=>{ %>
            <div class="border rounded p-3 mb-3">
              <div class="row">
                <div class="col-md-6 mb-2"><label class="form-label">Tên</label><input type="text" class="form-control" name="routes[<%= idx %>][name]" value="<%= r.name || '' %>"></div>
                <div class="col-md-6 mb-2"><label class="form-label">Tên EN</label><input type="text" class="form-control" name="routes[<%= idx %>][nameEn]" value="<%= r.nameEn || '' %>"></div>
                <div class="col-md-6 mb-2"><label class="form-label">Từ</label><input type="text" class="form-control" name="routes[<%= idx %>][from]" value="<%= r.from || '' %>"></div>
                <div class="col-md-6 mb-2"><label class="form-label">Đến</label><input type="text" class="form-control" name="routes[<%= idx %>][to]" value="<%= r.to || '' %>"></div>
                <div class="col-md-4 mb-2"><label class="form-label">Thời gian</label><input type="text" class="form-control" name="routes[<%= idx %>][duration]" value="<%= r.duration || '' %>"></div>
                <div class="col-md-4 mb-2"><label class="form-label">Tần suất</label><input type="text" class="form-control" name="routes[<%= idx %>][frequency]" value="<%= r.frequency || '' %>"></div>
                <div class="col-md-4 mb-2"><label class="form-label">Giá (VND)</label><input type="number" step="any" class="form-control" name="routes[<%= idx %>][price]" value="<%= r.price || '' %>"></div>
              </div>
            </div>
            <% }) %>
          </div>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRoute()"><i class="fas fa-plus me-1"></i>Thêm tuyến</button>
        </div>
      </div>
    </div>

    <!-- Media & Tags -->
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0"><i class="fas fa-images me-2"></i>Hình ảnh & Tags</h5></div>
        <div class="card-body">
          <div class="row">
            <div class="col-12 mb-3">
              <div class="d-flex flex-wrap gap-2">
                <% (item.images||[]).forEach((img, idx)=>{ %>
                  <div class="position-relative">
                    <img src="<%= img.url %>" style="width:100px;height:100px;object-fit:cover;border-radius:6px;">
                    <label class="form-check position-absolute top-0 end-0 m-1 bg-white p-1 rounded">
                      <input type="checkbox" class="form-check-input" name="removeImages" value="<%= idx %>"> Xóa
                    </label>
                  </div>
                <% }) %>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Thêm ảnh (upload)</label>
              <input type="file" class="form-control" name="images" multiple accept="image/*">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Tags</label>
              <div id="tags-container">
                <% (item.tags||['']).forEach(val => { %>
                <div class="input-group mb-2">
                  <input type="text" class="form-control" name="tags[]" value="<%= val %>" placeholder="VD: nhanh, rẻ">
                  <button type="button" class="btn btn-outline-danger" onclick="removeField(this)"><i class="fas fa-times"></i></button>
                </div>
                <% }) %>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="addField('tags-container','tags[]','VD: nhanh, rẻ')"><i class="fas fa-plus me-1"></i>Thêm</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status -->
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Trạng thái</h5></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" name="isActive" <%= item.isActive?'checked':'' %> >
                <label class="form-check-label">Kích hoạt</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" name="featured" <%= item.featured?'checked':'' %> >
                <label class="form-check-label">Nổi bật</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="col-12">
      <div class="d-flex justify-content-end gap-2">
        <a href="/admin/transportations" class="btn btn-secondary"><i class="fas fa-times me-2"></i>Hủy</a>
        <button class="btn btn-primary"><i class="fas fa-save me-2"></i>Lưu thay đổi</button>
      </div>
    </div>
  </div>
</form>

<script>
function addField(containerId, name, placeholder){
  const c = document.getElementById(containerId);
  const div = document.createElement('div');
  div.className = 'input-group mb-2';
  div.innerHTML = `
    <input type=\"text\" class=\"form-control\" name=\"${name}\" placeholder=\"${placeholder}\"> 
    <button type=\"button\" class=\"btn btn-outline-danger\" onclick=\"removeField(this)\"><i class=\"fas fa-times\"></i></button>
  `;
  c.appendChild(div);
}
function removeField(btn){ btn.parentElement.remove(); }

let routeIndex = <%= (item.routes||[]).length %>;
function addRoute(){
  const wrap = document.getElementById('routes');
  const idx = routeIndex++;
  const block = document.createElement('div');
  block.className = 'border rounded p-3 mb-3';
  block.innerHTML = `
    <div class=\"row\">
      <div class=\"col-md-6 mb-2\"><label class=\"form-label\">Tên</label><input type=\"text\" class=\"form-control\" name=\"routes[${idx}][name]\"></div>
      <div class=\"col-md-6 mb-2\"><label class=\"form-label\">Tên EN</label><input type=\"text\" class=\"form-control\" name=\"routes[${idx}][nameEn]\"></div>
      <div class=\"col-md-6 mb-2\"><label class=\"form-label\">Từ</label><input type=\"text\" class=\"form-control\" name=\"routes[${idx}][from]\"></div>
      <div class=\"col-md-6 mb-2\"><label class=\"form-label\">Đến</label><input type=\"text\" class=\"form-control\" name=\"routes[${idx}][to]\"></div>
      <div class=\"col-md-4 mb-2\"><label class=\"form-label\">Thời gian</label><input type=\"text\" class=\"form-control\" name=\"routes[${idx}][duration]\"></div>
      <div class=\"col-md-4 mb-2\"><label class=\"form-label\">Tần suất</label><input type=\"text\" class=\"form-control\" name=\"routes[${idx}][frequency]\"></div>
      <div class=\"col-md-4 mb-2\"><label class=\"form-label\">Giá (VND)</label><input type=\"number\" step=\"any\" class=\"form-control\" name=\"routes[${idx}][price]\"></div>
    </div>
  `;
  wrap.appendChild(block);
}
</script>



<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title><%= (attraction && (attraction.title || attraction.name)) || 'Chi tiết điểm tham quan' %> | HÀ NỘI</title>
        <meta name="description" content="<%= (attraction && (attraction.seoDescription || attraction.shortDescription)) || 'Chi tiết điểm tham quan Hà Nội' %>" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="/client/css/style.css" />
        <link rel="stylesheet" href="/client/css/responsive.css" />
        <link rel="stylesheet" href="/client/css/harmony.css" />
        <link rel="stylesheet" href="/client/css/attraction-detail.css" />
        <link rel="stylesheet" href="/client/css/review-widgets.css" />
        <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="/client/img/apple-touch-icon.png" />
        <link rel="icon" type="image/png" sizes="32x32" href="/client/img/favicon-32x32.png" />
        <link rel="icon" type="image/png" sizes="16x16" href="/client/img/favicon-16x16.png" />
        <link rel="manifest" href="/client/img/site.webmanifest" />
    </head>
    <body>
        <%- include('../../partials/header') %>
        <% /* ===========================================
             DYNAMIC DATA INITIALIZATION
             ===========================================
             Data will be managed by attraction-data.js
             This ensures clean separation of concerns
             =========================================== */ %>
        <% var attraction = (typeof attraction !== 'undefined' && attraction) ? attraction : null; %>
        <% const bannerUrl = (attraction && (attraction.heroImage || (attraction.images && attraction.images[0] && attraction.images[0].url))) || '/client/img/header-bg.jfif'; %>
        <!-- Banner -->
        <header class="page-header attraction-banner" style="background-image: url('<%= bannerUrl %>');">
            <div class="header-content">
                <h2 id="quote">
                    <%= attraction && attraction.category === 'nhan-van' ? 'Điểm tham quan nhân văn' :
                        attraction && attraction.category === 'tu-nhien' ? 'Điểm đến tham quan tự nhiên' : 'Điểm tham quan' %>
                </h2>
                <div class="line"></div>
                <h1><%= (attraction && (attraction.title || attraction.name)) || 'Điểm tham quan' %></h1>
                <p class="font-color">
                    <%= (attraction && attraction.shortDescription) || 'Khám phá vẻ đẹp văn hóa Hà Nội' %>
                </p>
                <% if (attraction && attraction.hasReviewWidget) { %>
                    <div class="banner-rating">
                        <div class="stars">
                            <i class="fa fa-star active"></i>
                            <i class="fa fa-star active"></i>
                            <i class="fa fa-star active"></i>
                            <i class="fa fa-star active"></i>
                            <i class="fa fa-star active"></i>
                        </div>
                        <span class="rating-text">
                            Đánh giá từ Google Reviews
                        </span>
                    </div>
                <% } %>
            </div>
        </header>

        <main class="attraction-detail main" aria-label="Nội dung chi tiết điểm tham quan">
            <div class="container">
                <!-- Map Overview Section -->
                <section id="map-overview" class="content-section map-overview">
                    <div class="itinerary-overview__map-container">
                        <div class="itinerary-overview__map-inner">
                            <div id="glanceMap"
                                 class="itinerary-overview__map"
                                 data-lat="<%= (attraction && (attraction.lat || attraction.coordinates?.lat)) || 21.028511 %>"
                                 data-lng="<%= (attraction && (attraction.lng || attraction.coordinates?.lng)) || 105.804817 %>"
                                 data-zoom="<%= (attraction && (attraction.mapZoom || attraction.map?.zoom)) || 14 %>"
                                 data-name="<%= (attraction && (attraction.title || attraction.name)) || '' %>"
                                 data-address="<%= (attraction && attraction.address) || '' %>"
                                 data-image="<%= (attraction && (attraction.heroImage || (attraction.images && attraction.images[0] && attraction.images[0].url))) || '' %>"
                                 data-url="<%= (attraction && ('/attraction/' + (attraction.slug || attraction._id))) || '' %>"
                                 data-route='<%- JSON.stringify((attraction && attraction.route) || []) %>'></div>
                            <div class="map-overview__heading">
                                <h2>Bản đồ tổng quan</h2>
                                <p>Vị trí và phạm vi điểm tham quan</p>
                            </div>
                            
                        </div>
                        <div class="itinerary-overview__map-gradient-vertical"></div>
                        <div class="itinerary-overview__map-gradient-horizontal"></div>
                    </div>
                </section>
                <!-- ===========================================
                     SECTION 1: INTRODUCTION & BASIC INFO
                     =========================================== -->
                <section id="attraction-intro" class="content-section itinerary-day no-margin-top">
                    <div class="itinerary-day__hero-wrapper">
                        <div class="itinerary-day__hero-media">
                            <img src="<%= (attraction && attraction.images && attraction.images[0] && attraction.images[0].url) || '/client/img/carousel-img5.jpg' %>" 
                                 alt="<%= (attraction && (attraction.title || attraction.name)) || 'Điểm tham quan' %>" 
                                 loading="lazy" />
                            <div class="itinerary-day__banner-title">
                                <h2>Chào mừng tới <%= (attraction && (attraction.title || attraction.name)) || 'Điểm tham quan' %></h2>
                            </div>
                        </div>
                    </div>

                    <div class="itinerary-day__overlay">
                        <div class="itinerary-day__content-container">
                            <!-- NEW LAYOUT: Side by side Introduction and Basic Info -->
                            <div class="intro-layout">
                                <!-- LEFT: Introduction -->
                                <div class="intro-section">
                                    <div class="itinerary-day__description-card">
                                        <div class="itinerary-day__description">
                                            <h3>Giới thiệu chung</h3>
                                            <div class="description-content">
                                                <p><%= (attraction && attraction.description) || 'Khám phá điểm tham quan thú vị tại Hà Nội với lịch sử và văn hóa đặc sắc.' %></p>
                                                <% if (attraction && attraction.intro) { %>
                                                    <p><%= attraction.intro %></p>
                                                <% } %>
                                                <% if (attraction && attraction.history) { %>
                                                    <h4>Lịch sử</h4>
                                                    <p><%= attraction.history %></p>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- RIGHT: Basic Info -->
                                <div class="info-section">
                                    <div class="itinerary-day__info-card">
                                        <h3>Thông tin cơ bản</h3>
                                        <ul class="itinerary-day__info-list">
                                            <li><strong>Vị trí</strong>: <%= (attraction && attraction.address) || 'Địa chỉ chưa cập nhật' %></li>
                                            
                                            <!-- Giờ mở cửa -->
                                            <% if (attraction && attraction.openHours && attraction.openHours.length > 0) { %>
                                            <li><strong>Giờ mở cửa</strong>:
                                                <ul>
                                                    <% attraction.openHours.forEach(function(hour) { %>
                                                    <li><%= hour %></li>
                                                    <% }); %>
                                                </ul>
                                            </li>
                                            <% } else if (attraction && attraction.openingHours) { %>
                                            <li><strong>Giờ mở cửa</strong>:
                                                <ul>
                                                    <% if (attraction.openingHours.summer && attraction.openingHours.summer.open && attraction.openingHours.summer.close) { %>
                                                    <li>Mùa hè: <%= attraction.openingHours.summer.open %> - <%= attraction.openingHours.summer.close %></li>
                                                    <% } %>
                                                    <% if (attraction.openingHours.winter && attraction.openingHours.winter.open && attraction.openingHours.winter.close) { %>
                                                    <li>Mùa đông: <%= attraction.openingHours.winter.open %> - <%= attraction.openingHours.winter.close %></li>
                                                    <% } %>
                                                    <% if (attraction.openingHours.general && attraction.openingHours.general.length > 0) { %>
                                                        <% attraction.openingHours.general.forEach(function(hour) { %>
                                                        <li><%= hour %></li>
                                                        <% }); %>
                                                    <% } %>
                                                </ul>
                                            </li>
                                            <% } else if (attraction && attraction.opening_hours) { %>
                                            <li><strong>Giờ mở cửa</strong>: <%= attraction.opening_hours %></li>
                                            <% } else { %>
                                            <li><strong>Giờ mở cửa</strong>: Thông tin chưa cập nhật</li>
                                            <% } %>
                                            
                                            <!-- Giá vé -->
                                            <% if (attraction && attraction.tickets && attraction.tickets.length > 0) { %>
                                            <li><strong>Giá vé tham quan</strong>:
                                                <ul>
                                                    <% attraction.tickets.forEach(function(ticket) { %>
                                                    <li><%= ticket.type %>: <%= ticket.price %><% if (ticket.note) { %> (<%= ticket.note %>)<% } %></li>
                                                    <% }); %>
                                                </ul>
                                            </li>
                                            <% } else if (attraction && attraction.ticketPrices) { %>
                                            <li><strong>Giá vé tham quan</strong>:
                                                <ul>
                                                    <% if (attraction.ticketPrices.adult) { %>
                                                    <li>Người lớn: <%= attraction.ticketPrices.adult.toLocaleString() %> VNĐ</li>
                                                    <% } %>
                                                    <% if (attraction.ticketPrices.student) { %>
                                                    <li>Học sinh, sinh viên: <%= attraction.ticketPrices.student.toLocaleString() %> VNĐ</li>
                                                    <% } %>
                                                    <% if (attraction.ticketPrices.elderly) { %>
                                                    <li>Người cao tuổi: <%= attraction.ticketPrices.elderly.toLocaleString() %> VNĐ</li>
                                                    <% } %>
                                                    <% if (attraction.ticketPrices.child !== undefined) { %>
                                                    <li>Trẻ em: <%= attraction.ticketPrices.child === 0 ? 'Miễn phí' : attraction.ticketPrices.child.toLocaleString() + ' VNĐ' %></li>
                                                    <% } %>
                                                    <% if (attraction.ticketPrices.note) { %>
                                                    <li class="note"><%= attraction.ticketPrices.note %></li>
                                                    <% } %>
                                                </ul>
                                            </li>
                                            <% } else if (attraction && attraction.ticketInfoText) { %>
                                            <li><strong>Giá vé tham quan</strong>:
                                                <div class="ticket-info-text"><pre style="white-space: pre-wrap; margin: 0;"> <%= attraction.ticketInfoText %></pre></div>
                                            </li>
                                            <% } else { %>
                                            <li><strong>Giá vé tham quan</strong>: Thông tin chưa cập nhật</li>
                                            <% } %>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Info Row -->
                            <div class="additional-info-row">
                                <% if (attraction && attraction.amenities && attraction.amenities.length > 0) { %>
                                <div class="itinerary-day__amenities">
                                    <h3>Tiện ích</h3>
                                    <ul class="itinerary-day__amenities-list">
                                        <% attraction.amenities.forEach(function(amenity) { %>
                                        <li><%= amenity %></li>
                                        <% }); %>
                                    </ul>
                                </div>
                                <% } %>

                                <% if (attraction && attraction.tags && attraction.tags.length > 0) { %>
                                <div class="itinerary-day__tags">
                                    <h3>Tags</h3>
                                    <div class="tags-container">
                                        <% attraction.tags.forEach(function(tag) { %>
                                        <span class="tag"><%= tag %></span>
                                        <% }); %>
                                    </div>
                                </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ===========================================
                     SECTION 2: EXPERIENCES & GUIDELINES
                     =========================================== -->
                <section id="attraction-experiences" class="content-section itinerary-day">
                    <div class="itinerary-day__hero-wrapper">
                        <div class="itinerary-day__hero-media">
                            <img src="<%= (attraction && attraction.images && attraction.images[1] && attraction.images[1].url) || '/client/img/carousel-img4.jpg' %>" 
                                 alt="<%= (attraction && (attraction.title || attraction.name)) || 'Điểm tham quan' %> - Trải nghiệm" 
                                 loading="lazy" />
                        </div>
                    </div>

                    <div class="itinerary-day__overlay">
                        <div class="itinerary-day__content-container">
                            <div class="itinerary-day__columns">
                                <!-- LEFT COLUMN: Experiences -->
                                <div class="itinerary-day__column-left">
                                    <div class="itinerary-day__experiences">
                                        <h3>Trải nghiệm của du khách</h3>
                                        <% if (attraction && attraction.experiences && attraction.experiences.length > 0) { %>
                                        <div class="experiences-grid">
                                            <% attraction.experiences.forEach(function(experience) { %>
                                            <div class="experience-card">
                                                <div class="experience-icon">
                                                    <i class="fa <%= experience.icon || 'fa-star' %>"></i>
                                                </div>
                                                <div class="experience-content">
                                                    <h4><%= experience.title %></h4>
                                                    <p><%= experience.text %></p>
                                                    <div class="experience-meta">
                                                        <span class="duration"><i class="fa fa-clock-o"></i> <%= experience.duration %></span>
                                                        <span class="difficulty difficulty-<%= experience.difficulty ? experience.difficulty.toLowerCase() : 'easy' %>">
                                                            <i class="fa fa-signal"></i> <%= experience.difficulty || 'Dễ' %>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <% }); %>
                                        </div>
                                        <% } else if (attraction && attraction.highlights && attraction.highlights.length > 0) { %>
                                        <ul class="itinerary-day__notes-list">
                                            <% attraction.highlights.forEach(function(highlight) { %>
                                            <li><%= highlight %></li>
                                            <% }); %>
                                        </ul>
                                        <% } else { %>
                                        <div class="no-experiences"><p>Thông tin trải nghiệm đang được cập nhật. Vui lòng quay lại sau.</p></div>
                                        <% } %>
                                    </div>
                                </div>

                                <!-- RIGHT COLUMN: Guidelines & Rules -->
                                <div class="itinerary-day__column-right">
                                    <div class="itinerary-day__guidelines">
                                        <h3>Lưu ý tham quan cho du khách</h3>
                                        <% if (attraction && attraction.rules && attraction.rules.length > 0) { %>
                                        <ul class="itinerary-day__notes-list">
                                            <% attraction.rules.forEach(function(rule) { %>
                                            <li><%= rule %></li>
                                            <% }); %>
                                        </ul>
                                        <% } else if (attraction && attraction.notes && attraction.notes.length > 0) { %>
                                        <ul class="itinerary-day__notes-list">
                                            <% attraction.notes.forEach(function(note) { %>
                                            <li><%= note %></li>
                                            <% }); %>
                                        </ul>
                                        <% } else { %>
                                        <div class="no-guidelines">
                                            <p>Thông tin hướng dẫn đang được cập nhật.</p>
                                        </div>
                                        <% } %>
                                    </div>

                                    <% if (attraction && attraction.tips && attraction.tips.length > 0) { %>
                                    <div class="itinerary-day__tips">
                                        <h3>Mẹo tham quan</h3>
                                        <ul class="itinerary-day__tips-list">
                                            <% attraction.tips.forEach(function(tip) { %>
                                            <li><%= tip %></li>
                                            <% }); %>
                                        </ul>
                                    </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Gallery Section -->
                <section id="gallery" class="content-section">
                    <div class="section-header">
                        <h2>Hình ảnh</h2>
                        <p>Khám phá vẻ đẹp qua những bức ảnh</p>
                    </div>
                    
                    <div class="gallery-grid">
                        <% if (attraction && attraction.images && attraction.images.length > 0) { %>
                            <% attraction.images.forEach(function(img, index) { %>
                                <div class="gallery-item" data-index="<%= index %>">
                                    <img src="<%= img.url %>" 
                                         alt="<%= img.alt || img.caption || 'Hình ảnh điểm tham quan' %>" 
                                         loading="lazy" />
                                    <div class="gallery-overlay">
                                        <button class="gallery-btn" type="button">
                                            <i class="fa fa-search-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="no-gallery">
                                <p>Hình ảnh đang được cập nhật</p>
                            </div>
                        <% } %>
                    </div>
                </section>

                <!-- Reviews Section (Pro) -->
                <section id="reviews" class="content-section reviews-pro">
                    <div class="reviews-pro__header">
                        <div class="reviews-pro__heading">
                            <h2>Đừng chỉ nghe chúng tôi, hãy nghe du khách</h2>
                            <p class="subheading">Chúng tôi yêu du khách của mình – và rất vui vì điều đó là tương hỗ.</p>
                        </div>
                    </div>

                    <!-- Review Widget Container -->
                    <div class="reviews-widget-container">
                        <% if (attraction && attraction.reviewWidgetScript && attraction.reviewWidgetScript.trim()) { %>
                            <!-- Render the review widget script (Shapo, EmbedSocial, etc.) -->
                            <div class="widget-wrapper">
                                <%- attraction.reviewWidgetScript %>
                            </div>
                        <% } else { %>
                            <!-- Fallback: No reviews message -->
                            <div class="no-reviews-widget">
                                <div class="reviews-pro__card">
                                    <img class="reviews-pro__quote" src="/client/img/quote.svg" alt="Quote" />
                                    <div class="reviews-pro__text">Chưa có đánh giá nào. Hãy là người đầu tiên chia sẻ trải nghiệm của bạn!</div>
                                    <div class="reviews-pro__stars">
                                        <i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i>
                                    </div>
                                    <div class="reviews-pro__meta">
                                        <span class="name">Khách du lịch</span>
                                        <span class="dot"></span>
                                        <span class="country">Việt Nam</span>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </section>
            </div>
        </main>

        <!-- Gallery Modal -->
        <div class="gallery-modal" id="galleryModal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <button class="modal-close" type="button">
                    <i class="fa fa-times"></i>
                </button>
                <div class="modal-nav">
                    <button class="nav-prev" type="button">
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <button class="nav-next" type="button">
                        <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
                <div class="modal-image">
                    <img src="" alt="Gallery image" />
                </div>
                <div class="modal-info">
                    <span class="image-counter">1 / 4</span>
                </div>
            </div>
        </div>


        <!-- up scroll -->
        <i class="arrow" onclick="topFunction()" id="upbtn"></i>

        <!--footer-->
        <%- include('../../partials/footer') %>
        <!--footer-->

        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="/client/js/includes.js"></script>
        <script src="/client/js/script.js"></script>
        <script src="/client/js/attraction-data.js"></script>
        <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
        <script src="/client/js/attraction-detail.js"></script>
        
        <!-- Initialize Dynamic Data -->
        <script>
            // Initialize attraction data with server data
            window.AttractionData.initialize(null);
            
            // Initialize review widgets
            document.addEventListener('DOMContentLoaded', function() {
                initializeReviewWidgets();
            });
            
            function initializeReviewWidgets() {
                const widgetWrapper = document.querySelector('.widget-wrapper');
                if (!widgetWrapper) return;
                
                // Add loading class initially
                widgetWrapper.classList.add('loading');
                
                // Check for Shapo widget
                const shapoWidget = document.getElementById('shapo-widget-5e8084e2fdcaa2cd9b10');
                if (shapoWidget) {
                    // Monitor when Shapo widget loads
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                                widgetWrapper.classList.remove('loading');
                                widgetWrapper.classList.add('loaded');
                            }
                        });
                    });
                    
                    observer.observe(shapoWidget, {
                        childList: true,
                        subtree: true
                    });
                    
                    // Fallback timeout
                    setTimeout(function() {
                        if (widgetWrapper.classList.contains('loading')) {
                            widgetWrapper.classList.remove('loading');
                            widgetWrapper.classList.add('loaded');
                        }
                    }, 5000);
                } else {
                    // No widget found, remove loading state
                    widgetWrapper.classList.remove('loading');
                }
            }
        </script>
    </body>
    </html>


<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title><%= (food && food.title) || 'Chi tiết ẩm thực' %> | HÀ NỘI</title>
        <meta name="description" content="<%= (food && food.seoDescription) || 'Ẩm thực Hà Nội' %>" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="/client/css/style.css" />
        <link rel="stylesheet" href="/client/css/responsive.css" />
        <link rel="stylesheet" href="/client/css/blog.css" />
        <link rel="stylesheet" href="/client/css/harmony.css" />
        <link rel="stylesheet" href="/client/css/cuisine-detail.css" />
        <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="/client/img/apple-touch-icon.png" />
        <link rel="icon" type="image/png" sizes="32x32" href="/client/img/favicon-32x32.png" />
        <link rel="icon" type="image/png" sizes="16x16" href="/client/img/favicon-16x16.png" />
        <link rel="manifest" href="/client/img/site.webmanifest" />
    </head>
    <body class="cuisine-detail-page">
        <%- include('../../partials/header') %>

        <!-- Banner -->
        <header class="page-header cuisine-banner" style="background-image: url('<%= (food && (food.heroImage || (food.images && food.images[0]))) || "https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=1200" %>');">
            <div class="header-content">
                <h2 id="quote">Ẩm thực & Đặc sản</h2>
                <div class="line"></div>
                <h1><%= (food && food.title) || 'Món đặc sản Hà Nội' %></h1>
                <p class="font-color">Khám phá hương vị truyền thống Hà Nội</p>
            </div>
        </header>

        <main class="cuisine-detail main">
            <div class="container">
                <% if (!food) { %>
                    <section class="content-section">
                        <h2 class="section-title"><i class="fa fa-warning"></i> Không tìm thấy món ăn</h2>
                        <p>Rất tiếc, món ăn bạn tìm không tồn tại hoặc đã bị ẩn.</p>
                        <a href="/cuisine" class="ctn">Quay lại danh sách Ẩm thực</a>
                    </section>
                <% } else { %>
                <div class="main-grid">
                    <div>
                        <section class="content-section">
                            <h2 class="section-title"><i class="fa fa-book"></i> Giới thiệu</h2>
                            <div class="description">
                                <% var paragraphs = (food && food.description && Array.isArray(food.description)) ? food.description : (food && food.description ? [food.description] : []); %>
                                <% if (!paragraphs.length) { %>
                                    <p>Bài viết về món ăn đang được cập nhật.</p>
                                <% } else { paragraphs.forEach(function(p){ %>
                                    <p><%= p %></p>
                                <% }) } %>
                            </div>


                            <% var ingredients = (food && food.ingredients) || []; %>
                            <% if (ingredients.length) { %>
                            <h3 class="subsection-title"><i class="fa fa-pepper"></i> Thành phần món ăn</h3>
                            <div class="ingredients-grid">
                                <% ingredients.forEach(function(it){ %>
                                <div class="ingredient-item">
                                    <i class="fa fa-circle"></i>
                                    <div>
                                        <strong><%= it.name %></strong>
                                        <% if (it.note) { %><p class="muted"><%= it.note %></p><% } %>
                                    </div>
                                </div>
                                <% }) %>
                            </div>
                            <% } %>

                            <% var gallery = (food && food.images) || []; %>
                            <% if (gallery.length) { %>
                            <h3 class="subsection-title"><i class="fa fa-image"></i> Hình ảnh món ăn</h3>
                            <div class="image-gallery">
                                <% gallery.slice(0, 6).forEach(function(img){ %>
                                <div class="gallery-item"><img src="<%= img %>" alt="Hình món ăn" loading="lazy" /></div>
                                <% }) %>
                            </div>
                            <% } %>
                        </section>
                    </div>

                    <aside class="sidebar">
                        <% var similars = (food && food.similar) || []; %>
                        <% if (similars.length) { %>
                        <section class="info-card">
                            <h3><i class="fa fa-heart"></i> Món ăn tương tự</h3>
                            <div class="similar-list">
                                <% similars.forEach(function(s){ %>
                                <a class="similar-link" href="<%= s.href || '#' %>"><i class="fa fa-cutlery"></i> <%= s.name %></a>
                                <% }) %>
                            </div>
                        </section>
                        <% } %>
                    </aside>
                </div>

                <% var restaurants = (food && food.restaurants) || []; %>
                <% if (restaurants.length) { %>
                <section class="blog-section" id="cuisine-restaurants">
                    <div class="container">
                        <div class="title">
                            <h1 class="font-color">Địa điểm thưởng thức nổi bật</h1>
                            <div class="line"></div>
                        </div>
                        <div class="blog-grid">
                            <% restaurants.forEach(function(r, idx){ %>
                            <% var defaultImage = 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800'; %>
                            <article class="blog-card" data-restaurant-index="<%= idx %>">
                                <div class="blog-image" data-images='<%= JSON.stringify(r.images || []) %>' data-restaurant-name="<%= r.name %>">
                                    <img src="<%= r.image || defaultImage %>" alt="<%= r.name %>" />
                                    <div class="blog-category"><%= r.category || 'Nhà hàng' %></div>
                                </div>
                                <div class="blog-content">
                                    <div class="blog-meta">
                                        <span class="blog-date"><i class="fa fa-star"></i> <%= r.rating || '4.5' %>/5</span>
                                        <span class="blog-author"><i class="fa fa-map-marker"></i> <%= r.distance || r.address || '' %></span>
                                    </div>
                                    <h3 class="blog-title"><%= r.name %></h3>
                                    <% if (r.description) { %>
                                    <p class="blog-excerpt"><%= r.description %></p>
                                    <% } %>
                                    <a href="#" class="blog-read-more" onclick="viewRestaurantDetail('<%= r.id || idx %>', '<%= r.name %>'); return false;">Xem chi tiết <i class="fa fa-arrow-right"></i></a>
                                </div>
                            </article>
                            <% }) %>
                        </div>
                    </div>
                </section>
                <% } %>

                <% var tips = (food && food.tips) || []; %>
                <% if (tips.length) { %>
                <section class="tips-section">
                    <div class="container">
                        <h2 class="section-title"><i class="fa fa-lightbulb-o"></i> Mẹo thưởng thức</h2>
                        <div class="tips-grid">
                            <% tips.forEach(function(t){ %>
                            <div class="tip-card">
                                <h4><i class="fa fa-lightbulb-o"></i> <%= t %></h4>
                            </div>
                            <% }) %>
                        </div>
                    </div>
                </section>
                <% } %>

                <% if (food && food.recipe) { %>
                <section class="recipe-section">
                    <h2 class="section-title"><i class="fa fa-book"></i> Công thức nấu</h2>
                    <div class="recipe-content">
                        <div class="recipe-text">
                            <%= food.recipe.replace(/\n/g, '<br>') %>
                        </div>
                    </div>
                </section>
                <% } %>
            </div>
            <% } %>
        </main>

        <!-- Restaurant Images Modal -->
        <div class="restaurant-images-modal" id="restaurantImagesModal">
            <div class="modal-overlay" onclick="closeRestaurantImagesModal()"></div>
            <div class="modal-content">
                <button class="modal-close" type="button" onclick="closeRestaurantImagesModal()">
                    <i class="fa fa-times"></i>
                </button>
                <div class="modal-header">
                    <h3 id="restaurantModalTitle">Hình ảnh địa điểm</h3>
                </div>
                <div class="modal-nav">
                    <button class="nav-prev" type="button" onclick="prevRestaurantImage()">
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <button class="nav-next" type="button" onclick="nextRestaurantImage()">
                        <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
                <div class="modal-image">
                    <img src="" alt="Restaurant image" id="restaurantModalImage" />
                </div>
                <div class="modal-info">
                    <span class="image-counter" id="restaurantImageCounter">1 / 1</span>
                </div>
            </div>
        </div>

        <!-- ===========================================
             REVIEWS SECTION
             =========================================== -->
        <% if (food && food._id) { %>
            <%- include('../../components/reviews-section', { 
                targetType: 'food',
                targetId: food._id,
                title: 'Đánh giá từ thực khách',
                showForm: true,
                currentUrl: '/cuisine/' + (food.slug || food._id)
            }) %>
        <% } %>

        <!-- Contact Section -->
        <%- include('../../components/contact-section', { sectionId: 'contact-cuisine-detail' }) %>

        <!-- up scroll -->
        <i class="arrow" onclick="topFunction()" id="upbtn"></i>

        <%- include('../../partials/footer') %>

        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="/client/js/includes.js"></script>
        <script src="/client/js/script.js"></script>
        <script src="/client/js/slug.js"></script>
        <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
        <script src="/client/js/cuisine-detail.js"></script>

        <script>
        // Restaurant images modal functionality
        let currentRestaurantImages = [];
        let currentRestaurantImageIndex = 0;
        let currentRestaurantName = '';

        function showRestaurantImages(restaurantIndex) {
            const restaurantCard = document.querySelector('[data-restaurant-index="' + restaurantIndex + '"]');
            if (!restaurantCard) return;

            const imagesData = restaurantCard.querySelector('.blog-image').getAttribute('data-images');
            const restaurantName = restaurantCard.querySelector('.blog-image').getAttribute('data-restaurant-name');
            
            try {
                currentRestaurantImages = JSON.parse(imagesData);
                currentRestaurantName = restaurantName;
                currentRestaurantImageIndex = 0;

                if (currentRestaurantImages.length === 0) {
                    alert('Không có hình ảnh nào cho địa điểm này');
                    return;
                }

                // Update modal title
                document.getElementById('restaurantModalTitle').textContent = 'Hình ảnh ' + restaurantName;
                
                // Show modal
                document.getElementById('restaurantImagesModal').classList.add('active');
                
                // Show first image
                showRestaurantImage(0);
            } catch (e) {
                console.error('Error parsing restaurant images:', e);
                alert('Có lỗi khi tải hình ảnh');
            }
        }

        function showRestaurantImage(index) {
            if (currentRestaurantImages.length === 0) return;
            
            currentRestaurantImageIndex = index;
            const imageUrl = currentRestaurantImages[index];
            
            document.getElementById('restaurantModalImage').src = imageUrl;
            document.getElementById('restaurantImageCounter').textContent = (index + 1) + ' / ' + currentRestaurantImages.length;
            
            // Show/hide navigation buttons
            const prevBtn = document.querySelector('.restaurant-images-modal .nav-prev');
            const nextBtn = document.querySelector('.restaurant-images-modal .nav-next');
            
            if (prevBtn) prevBtn.style.display = currentRestaurantImages.length > 1 ? 'block' : 'none';
            if (nextBtn) nextBtn.style.display = currentRestaurantImages.length > 1 ? 'block' : 'none';
        }

        function prevRestaurantImage() {
            if (currentRestaurantImages.length === 0) return;
            const newIndex = (currentRestaurantImageIndex - 1 + currentRestaurantImages.length) % currentRestaurantImages.length;
            showRestaurantImage(newIndex);
        }

        function nextRestaurantImage() {
            if (currentRestaurantImages.length === 0) return;
            const newIndex = (currentRestaurantImageIndex + 1) % currentRestaurantImages.length;
            showRestaurantImage(newIndex);
        }

        function closeRestaurantImagesModal() {
            document.getElementById('restaurantImagesModal').classList.remove('active');
            currentRestaurantImages = [];
            currentRestaurantImageIndex = 0;
            currentRestaurantName = '';
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('restaurantImagesModal');
            if (modal && modal.classList.contains('active')) {
                if (e.key === 'Escape') {
                    closeRestaurantImagesModal();
                } else if (e.key === 'ArrowLeft') {
                    prevRestaurantImage();
                } else if (e.key === 'ArrowRight') {
                    nextRestaurantImage();
                }
            }
        });

        // Restaurant detail navigation
        function viewRestaurantDetail(restaurantId, restaurantName) {
            console.log('Viewing restaurant:', restaurantId, restaurantName);
            
            // Get current cuisine slug from URL
            const currentPath = window.location.pathname;
            const pathParts = currentPath.split('/');
            const cuisineSlug = pathParts[2]; // /cuisine/[cuisineSlug]
            
            // Create restaurant slug from name using utility function
            const restaurantSlug = createSlug(restaurantName);
            
            // Navigate to restaurant detail page within cuisine
            window.location.href = '/cuisine/' + cuisineSlug + '/' + restaurantSlug;
        }

        // Add click animation to restaurant cards (blog layout)
        document.addEventListener('DOMContentLoaded', function() {
            const restaurantCards = document.querySelectorAll('#cuisine-restaurants .blog-card');
            
            restaurantCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    // Add click animation
                    this.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });

            // Lightbox for cuisine image gallery
            try {
                var cuisineTitle = <%- JSON.stringify((food && food.title) || 'Món ăn') %>;
            } catch (e) { cuisineTitle = 'Món ăn'; }

            const galleryNodeList = document.querySelectorAll('.image-gallery img');
            const galleryArray = Array.prototype.slice.call(galleryNodeList);
            galleryArray.forEach(function(img, index) {
                img.style.cursor = 'zoom-in';
                img.addEventListener('click', function(ev) {
                    ev.preventDefault();
                    // collect all gallery image urls in order
                    currentRestaurantImages = galleryArray.map(function(el){ return el.getAttribute('src'); });
                    currentRestaurantName = cuisineTitle;
                    currentRestaurantImageIndex = index;

                    // title
                    var titleEl = document.getElementById('restaurantModalTitle');
                    if (titleEl) { titleEl.textContent = 'Hình ảnh món ăn - ' + cuisineTitle; }

                    // open modal on selected index
                    document.getElementById('restaurantImagesModal').classList.add('active');
                    showRestaurantImage(index);
                });
            });
        });
        </script>
    </body>
</html>
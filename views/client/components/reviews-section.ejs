<%
// =================================================================
// REVIEWS SECTION COMPONENT - Hệ thống đánh giá mới
// =================================================================
// Props:
// - targetType: 'attraction', 'accommodation', 'food', 'entertainment', 'tour', 'cuisine-place'
// - targetId: ID của đối tượng
// - title: Tiêu đề section (optional)
// - showForm: Hiển thị form đánh giá (default: true)
// =================================================================

const _title = (typeof title !== 'undefined' && title) 
  ? title 
  : "Đánh giá từ khách hàng";
const _targetType = targetType || 'attraction';
const _targetId = targetId || '';
const _showForm = (typeof showForm === 'undefined') ? true : showForm;
const _currentUser = typeof user !== 'undefined' ? user : null;
%>

<div class="reviews-section" data-target-type="<%= _targetType %>" data-target-id="<%= _targetId %>">
  
  <!-- =================================================================
       HEADER
       ================================================================= -->
  <div class="reviews-header">
    <h2 class="reviews-title">Khách hàng đánh giá</h2>
    </div>
  
  <div class="reviews-stats-container" id="reviewsStats">
    <div class="stats-loading">
      <div class="spinner"></div>
      <p>Đang tải thống kê...</p>
        </div>
      </div>
      
  <!-- =================================================================
       REVIEW FORM - Chỉ hiển thị khi user đã đăng nhập
       ================================================================= -->
  <% if (_showForm) { %>
    <div class="review-form-container" id="reviewFormContainer">
      <% if (_currentUser) { %>
        <%- include('review-form', { 
          targetType: _targetType, 
          targetId: _targetId,
          user: _currentUser
        }) %>
              <% } else { %>
        <div class="review-login-prompt">
          <div class="login-prompt-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <h3>Chia sẻ trải nghiệm của bạn</h3>
          <p>Đăng nhập để viết đánh giá và giúp mọi người có thêm thông tin hữu ích</p>
          <a href="/auth/login?redirect=<%= encodeURIComponent(typeof currentUrl !== 'undefined' ? currentUrl : '') %>" class="btn-primary">
            Đăng nhập để đánh giá
          </a>
        </div>
      <% } %>
    </div>
                <% } %>
                
  <!-- =================================================================
       REVIEWS LIST
       ================================================================= -->
  <div class="reviews-list-container" id="reviewsList">
    <div class="reviews-loading">
      <div class="spinner"></div>
      <p>Đang tải đánh giá...</p>
    </div>
  </div>
  
  <!-- =================================================================
       PAGINATION
       ================================================================= -->
  <div class="reviews-pagination" id="reviewsPagination"></div>

</div>

<!-- =================================================================
     STYLES
     ================================================================= -->
  <style>
/* ==========================
   CONTAINER & LAYOUT
   ========================== */
.reviews-section {
      background: #ffffff;
      border-radius: 16px;
  padding: 32px 28px;
  margin: 32px 0;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
  border: 1px solid #e5e7eb;
}

/* ==========================
   HEADER
   ========================== */
.reviews-header {
  margin-bottom: 20px;
}

.reviews-title {
  font-size: 1.25rem;
      font-weight: 700;
  color: #1a1a1a;
      margin: 0;
    }
  
/* ==========================
   STATS CONTAINER
   ========================== */
.reviews-stats-container {
  margin-bottom: 32px;
}

.review-stats-card {
  background: #ffffff;
  border-radius: 8px;
  padding: 20px;
  border: 1px solid #e5e7eb;
  margin-bottom: 24px;
}

.stats-title {
  font-size: 1rem;
  font-weight: 700;
  color: #1a1a1a;
  margin: 0 0 16px 0;
}

.stats-summary {
      display: flex;
  align-items: flex-start;
  gap: 32px;
      flex-wrap: wrap;
}

.average-rating {
  text-align: center;
  min-width: 120px;
}

.rating-number {
  font-size: 3rem;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 8px;
  color: #1a1a1a;
}

.rating-stars {
  display: flex;
  gap: 2px;
  justify-content: center;
  margin-bottom: 6px;
}
  
    .rating-stars .star { 
  font-size: 1.25rem;
  color: #fbbf24;
}

.rating-count {
  font-size: 0.8125rem;
  color: #6b7280;
}

.rating-distribution {
  flex: 1;
  min-width: 280px;
}

.distribution-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.distribution-label {
  font-size: 0.8125rem;
  font-weight: 400;
  min-width: 40px;
  display: flex;
  align-items: center;
  gap: 2px;
  color: #6b7280;
}

.distribution-label .star {
  color: #fbbf24;
  font-size: 0.875rem;
}

.distribution-bar {
  flex: 1;
  height: 6px;
  background: #e5e7eb;
  border-radius: 3px;
      overflow: hidden;
    }
  
.distribution-fill {
  height: 100%;
  background: #fbbf24;
  border-radius: 3px;
  transition: width 0.6s ease;
}

.distribution-count {
  font-size: 0.8125rem;
  font-weight: 400;
  min-width: 30px;
  text-align: right;
  color: #6b7280;
}

/* ==========================
   LOGIN PROMPT
   ========================== */
.review-login-prompt {
  text-align: center;
  padding: 48px 24px;
  background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
  border-radius: 12px;
  margin-bottom: 32px;
}

.login-prompt-icon {
  color: #6366f1;
  margin-bottom: 16px;
}

.review-login-prompt h3 {
  font-size: 1.375rem;
  font-weight: 700;
  color: #111827;
  margin-bottom: 8px;
}

.review-login-prompt p {
  font-size: 0.9375rem;
  color: #6b7280;
  margin-bottom: 20px;
}

.btn-primary {
  display: inline-block;
  background: #6366f1;
  color: #ffffff;
  padding: 12px 32px;
  border-radius: 8px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.btn-primary:hover {
  background: #4f46e5;
      transform: translateY(-2px); 
  box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
}

/* ==========================
   REVIEWS LIST
   ========================== */
.reviews-list-container {
  margin-top: 32px;
}

.review-item {
  background: #ffffff;
  border-bottom: 1px solid #e5e7eb;
  padding: 20px 0;
  margin-bottom: 0;
}

.review-item:last-child {
  border-bottom: none;
}

.review-header {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 16px;
}
  
    .reviewer-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
    }
  
    .reviewer-avatar-placeholder { 
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #3b82f6;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ffffff;
  font-size: 1rem;
  font-weight: 600;
  flex-shrink: 0;
}

.reviewer-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.reviewer-name { 
  font-size: 0.875rem;
  font-weight: 600;
  color: #1a1a1a;
  margin: 0;
  display: flex; 
  align-items: center; 
  gap: 6px;
  font-family: var(--ff-primary);
}

.verified-badge {
  background: #10b981;
  color: #ffffff;
  font-size: 0.625rem;
  padding: 2px 6px;
  border-radius: 10px;
  font-weight: 600;
}

.review-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.75rem;
  color: #6b7280;
  flex-wrap: wrap;
}

.review-rating { 
  display: flex;
  gap: 2px;
  align-items: center;
}

.review-rating .star {
  font-size: 0.875rem;
  color: #fbbf24;
}

.review-date {
  color: #9ca3af;
  font-size: 0.75rem;
  font-family: var(--ff-primary);
}

.review-title {
  font-size: 0.9375rem;
  font-weight: 600;
  color: #1a1a1a;
  margin-bottom: 8px;
  font-family: var(--ff-heading);
}

.review-content-wrapper {
  margin-left: 52px; /* Align with content below avatar */
  margin-top: 8px;
}

.review-content {
  font-size: 0.875rem;
  line-height: 1.6; 
  color: #4b5563;
  margin-bottom: 12px;
  font-family: var(--ff-primary);
}

.review-images {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.review-image {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 6px;
  cursor: pointer;
  transition: transform 0.2s;
  border: 1px solid #e5e7eb;
}

.review-image:hover {
  transform: scale(1.03);
}


/* ==========================
   PAGINATION
   ========================== */
.reviews-pagination {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 32px;
}

.page-btn {
  padding: 8px 14px;
  border: 1px solid #e5e7eb;
  background: #ffffff;
  color: #374151;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
}

.page-btn:hover:not(:disabled) {
  background: #f3f4f6;
  border-color: #d1d5db;
}

.page-btn.active {
  background: #6366f1;
  color: #ffffff;
  border-color: #6366f1;
}

.page-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ==========================
   LOADING STATES
   ========================== */
.stats-loading,
.reviews-loading {
  text-align: center;
  padding: 48px 24px;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f3f4f6;
  border-top-color: #6366f1;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.stats-loading p,
.reviews-loading p {
  color: #6b7280;
  font-size: 0.875rem;
}

.no-reviews {
  text-align: center;
  padding: 64px 24px;
  color: #6b7280;
}

.no-reviews-icon {
  font-size: 4rem;
  margin-bottom: 16px;
  opacity: 0.3;
}

.no-reviews h3 {
        font-size: 1.25rem;
  color: #374151;
  margin-bottom: 8px;
}

/* ==========================
   RESPONSIVE
   ========================== */
@media (max-width: 768px) {
  .reviews-section {
    padding: 20px 16px;
    margin: 20px 0;
  }

  .reviews-title {
    font-size: 1.125rem;
  }

  .review-content-wrapper {
    margin-left: 44px; /* Smaller margin on mobile */
  }

  .review-meta {
    gap: 8px;
  }

  .reviewer-name {
    font-size: 0.8125rem;
  }

  .review-content {
    font-size: 0.8125rem;
  }
  
  .review-stats-card {
    padding: 16px;
  }

  .stats-title {
    font-size: 0.9375rem;
  }

  .stats-summary {
    flex-direction: column;
    text-align: center;
  }

  .rating-number {
    font-size: 3rem;
  }

  .rating-distribution {
    width: 100%;
  }

  .review-item {
        padding: 16px;
  }

  .review-header {
    flex-direction: column;
  }

  .reviewer-avatar,
  .reviewer-avatar-placeholder {
    width: 48px;
    height: 48px;
    font-size: 1.125rem;
  }

  .review-image {
    width: 100px;
    height: 100px;
  }
}

@media (max-width: 480px) {
  .review-content-wrapper {
    margin-left: 0; /* No margin on very small screens */
    margin-top: 12px;
  }

  .review-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .reviewer-info {
    width: 100%;
  }

  .review-meta {
    justify-content: flex-start;
    gap: 6px;
  }

  .reviewer-name {
    font-size: 0.75rem;
  }

  .review-content {
    font-size: 0.75rem;
  }
}
</style>

<!-- =================================================================
     SCRIPT
     ================================================================= -->
<script>
(function() {
  const reviewsSection = document.querySelector('.reviews-section');
  if (!reviewsSection) return;

  const targetType = reviewsSection.dataset.targetType;
  const targetId = reviewsSection.dataset.targetId;
  let currentPage = 1;

  // =================================================================
  // LOAD STATS
  // =================================================================
  async function loadStats() {
    try {
      const response = await fetch(`/api/reviews/${targetType}/${targetId}?page=1&limit=1`);
      const data = await response.json();

      if (data.success && data.data.stats) {
        renderStats(data.data.stats);
      }
    } catch (error) {
      console.error('Error loading stats:', error);
      document.getElementById('reviewsStats').innerHTML = `
        <div class="no-reviews">
          <p>Không thể tải thống kê</p>
        </div>
      `;
    }
  }

  // =================================================================
  // RENDER STATS
  // =================================================================
  function renderStats(stats) {
    const total = stats.totalReviews;
    const avg = stats.averageRating || 0;
    const dist = stats.ratingDistribution || {};

    const fullStars = Math.floor(avg);
    const hasHalf = (avg % 1) >= 0.5;
    
    let starsHtml = '';
    for (let i = 0; i < 5; i++) {
      if (i < fullStars) {
        starsHtml += '<span class="star">★</span>';
      } else if (i === fullStars && hasHalf) {
        starsHtml += '<span class="star">★</span>';
      } else {
        starsHtml += '<span class="star" style="color: rgba(255,255,255,0.3)">★</span>';
      }
    }

    let distributionHtml = '';
    for (let i = 5; i >= 1; i--) {
      const count = dist[i] || 0;
      const percent = total > 0 ? (count / total * 100) : 0;
      distributionHtml += `
        <div class="distribution-row">
          <div class="distribution-label">
            <span>${i}</span>
            <span class="star">★</span>
          </div>
          <div class="distribution-bar">
            <div class="distribution-fill" style="width: ${percent}%"></div>
          </div>
          <div class="distribution-count">${count}</div>
        </div>
      `;
    }

    document.getElementById('reviewsStats').innerHTML = `
      <div class="review-stats-card">
        <h3 class="stats-title">Tổng quan</h3>
        <div class="stats-summary">
          <div class="average-rating">
            <div class="rating-number">${avg.toFixed(1)}</div>
            <div class="rating-stars">${starsHtml}</div>
            <div class="rating-count">(${total} đánh giá)</div>
          </div>
          <div class="rating-distribution">
            ${distributionHtml}
          </div>
        </div>
      </div>
    `;
  }

  // =================================================================
  // LOAD REVIEWS
  // =================================================================
  async function loadReviews(page = 1) {
    currentPage = page;
    const container = document.getElementById('reviewsList');
    
    container.innerHTML = `
      <div class="reviews-loading">
        <div class="spinner"></div>
        <p>Đang tải đánh giá...</p>
      </div>
    `;

    try {
      const response = await fetch(`/api/reviews/${targetType}/${targetId}?page=${page}&limit=10`);
      const data = await response.json();

      if (data.success) {
        renderReviews(data.data.reviews);
        renderPagination(data.data.pagination);
      } else {
        throw new Error(data.message);
      }
    } catch (error) {
      console.error('Error loading reviews:', error);
      container.innerHTML = `
        <div class="no-reviews">
          <div class="no-reviews-icon">📝</div>
          <h3>Chưa có đánh giá nào</h3>
        </div>
      `;
    }
  }

  // =================================================================
  // RENDER REVIEWS
  // =================================================================
  function renderReviews(reviews) {
    const container = document.getElementById('reviewsList');
    
    if (!reviews || reviews.length === 0) {
      container.innerHTML = `
        <div class="no-reviews">
          <div class="no-reviews-icon">📝</div>
          <h3>Chưa có đánh giá nào</h3>
        </div>
      `;
      return;
    }

    container.innerHTML = reviews.map(review => {
      const starsHtml = Array(review.rating).fill('<span class="star">★</span>').join('');
      const dateObj = new Date(review.createdAt);
      const date = dateObj.toLocaleDateString('vi-VN') + ' ' + dateObj.toLocaleTimeString('vi-VN');
      const avatarHtml = review.user.avatar 
        ? `<img src="${review.user.avatar}" alt="${review.user.name}" class="reviewer-avatar">`
        : `<div class="reviewer-avatar-placeholder">${review.user.name.charAt(0).toUpperCase()}</div>`;
      
      const imagesHtml = review.images && review.images.length > 0
        ? `<div class="review-images">
            ${review.images.map(img => `<img src="${img}" alt="Review image" class="review-image" onclick="viewImage('${img}')">`).join('')}
           </div>`
        : '';

      const verifiedBadge = review.verified 
        ? '<span class="verified-badge">✓ Đã xác minh</span>'
        : '';

      return `
        <div class="review-item" data-review-id="${review._id}">
          <div class="review-header">
            ${avatarHtml}
            <div class="reviewer-info">
              <div class="reviewer-name">
                ${review.user.name}
                ${verifiedBadge}
              </div>
              <div class="review-meta">
                <div class="review-rating">${starsHtml}</div>
                <span class="review-date">${date}</span>
              </div>
            </div>
          </div>
          <div class="review-content-wrapper">
            ${review.title ? `<h4 class="review-title">${review.title}</h4>` : ''}
            <div class="review-content">${review.content}</div>
            ${imagesHtml}
          </div>
        </div>
      `;
    }).join('');
  }

  // =================================================================
  // RENDER PAGINATION
  // =================================================================
  function renderPagination(pagination) {
    const container = document.getElementById('reviewsPagination');
    
    if (pagination.totalPages <= 1) {
      container.innerHTML = '';
      return;
    }

    let html = '';
    
    // Previous button
    html += `<button class="page-btn" ${!pagination.hasPrev ? 'disabled' : ''} 
              onclick="loadReviewsPage(${currentPage - 1})">‹</button>`;
    
    // Page numbers
    for (let i = 1; i <= pagination.totalPages; i++) {
      if (
        i === 1 || 
        i === pagination.totalPages || 
        (i >= currentPage - 1 && i <= currentPage + 1)
      ) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                  onclick="loadReviewsPage(${i})">${i}</button>`;
      } else if (i === currentPage - 2 || i === currentPage + 2) {
        html += '<span style="padding: 8px;">...</span>';
      }
    }
    
    // Next button
    html += `<button class="page-btn" ${!pagination.hasNext ? 'disabled' : ''} 
              onclick="loadReviewsPage(${currentPage + 1})">›</button>`;
    
    container.innerHTML = html;
  }

  // =================================================================
  // GLOBAL FUNCTIONS
  // =================================================================
  window.loadReviewsPage = function(page) {
    loadReviews(page);
    reviewsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  window.viewImage = function(url) {
    window.open(url, '_blank');
  };

  // =================================================================
  // INIT
  // =================================================================
  loadStats();
  loadReviews(1);
})();
  </script>
